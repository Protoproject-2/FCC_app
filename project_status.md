
# プロジェクト現状報告

## 1. プロジェクト概要

- **アプリ名:** FCC防犯アプリ
- **目的:** `voice.md`の記述から、5秒間隔で音声をサーバーにアップロードする機能を持つプロトタイプを開発していると推測されます。これは、緊急時の状況をリアルタイムで外部に伝えるための防犯目的の機能である可能性が高いです。
- **開発環境:**
    - **フレームワーク:** Flutter
    - **状態管理:** Riverpod
    - **UIコンポーネントテスト:** Widgetbook
    - **開発支援:** GeminiCLI

## 2. 主な機能と実装状況

ファイル構成と`pubspec.yaml`、`voice.md`から、以下の機能の実装が進められていると判断できます。

| 機能 | 関連ファイル/ライブラリ | 実装状況 |
| :--- | :--- | :--- |
| **音声録音** | `record` パッケージ, `lib/app/infra/audio_service.dart` | `record`パッケージが導入されており、`audio_service.dart`で録音機能の実装が進んでいると考えられます。`voice.md`の記述通り、連続録音したデータを5秒ごとに分割するロジックが中心となる見込みです。 |
| **音声データ送信** | `http` パッケージ, `lib/app/infra/audio_service.dart` | `http`パッケージが導入されており、録音した音声データをHTTPのmultipart/form-data形式でサーバーに送信する機能が実装されている、もしくは実装中であると推測されます。 |
| **キーワード検出** | `lib/app/infra/detection_service.dart`, `lib/app/infra/keyword_repository.dart` | 音声データから特定のキーワードを検出する機能。リポジトリとサービスが分離されており、テストしやすい構造になっています。具体的な検出ロジックは`detection_service.dart`に実装されていると思われます。 |
| **連絡先連携** | `lib/app/infra/contact_repository.dart` | 緊急連絡先などに通知するための連絡先情報を扱う機能。現在はリポジトリの定義のみで、具体的な実装はこれからである可能性があります。 |
| **UI** | `lib/app/ui/home/` | ホーム画面のUI。現状は基本的な画面構成のみで、各機能との連携はこれから実装する段階だと考えられます。 |

## 3. 推測される現状の課題

「先ほど出てたログ」に関する具体的な情報がないため、正確な問題の特定は困難ですが、現在の実装状況から以下のような課題に直面している可能性があります。

- **音声録音と送信の連携:**
    - 5秒ごとに音声を区切って送信する処理（ローリングバッファ）の実装が複雑で、タイミングに関する問題（音声の途切れ、重複など）が発生している可能性があります。
- **プラットフォーム固有の問題:**
    - iOS/Androidでのマイクへのアクセス権限の処理が適切に行われておらず、録音が開始できない。
    - アプリがバックグラウンドに回った際に、録音処理が停止してしまう。
- **サーバーサイドの連携:**
    - クライアントから送信された音声データを、サーバー側で正しく受け取れていない（エンコード形式の違い、リクエストボディのパース失敗など）。
- **バッテリー消費:**
    - `voice.md`の懸念事項にもある通り、連続的な録音と通信により、デバイスのバッテリー消費が激しくなっている可能性があります。

## 4. 次のステップ案

1. **問題の切り分け:**
    - まず、音声録音機能が単体で正しく動作するかを確認します（録音したデータをローカルに保存するなど）。
    - 次に、サーバーへの送信機能が単体で正しく動作するか、ダミーデータを用いてテストします。
2. **ログの追加:**
    - `audio_service.dart`内の録音開始/停止、データスライス、送信成功/失敗の各ポイントに詳細なログを仕込み、処理の流れとエラー箇所を特定できるようにします。
3. **ドキュメントの確認:**
    - `voice.md`の「設計チェックリスト」と現在の実装を見比べ、未実装の項目（再送戦略、サイズ制限など）がないか確認します。

